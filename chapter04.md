# 第4章 数学基础

计算机图形学是建立在虚拟世界上的数学模型。经常需要使用到矢量与矩阵（线性代数）。

## 笛卡尔坐标系

Cartesian coordinate system.

### 4.2.1 二维笛卡尔坐标系

图4.3 显示了一个二维笛卡尔坐标系。

![一个二维笛卡尔坐标系](images/chapter04_2d_cartesian_coordinate_system.png)

一个二维笛卡尔坐标系包含了两部分信息：

- 一个特殊的位置——原点，它是整个坐标系的中心。
- 两条过原点并且互相垂直的矢量，即x轴和y轴。这些坐标轴也被称为该坐标系的基矢量。

### 4.2.2 三维直角坐标系

![三维直角坐标系](images/chapter04_3d_cartesian_coordinate_system.png)

3个坐标轴之间互相垂直，且长度为1.

根据坐标轴方向，可以划分出两种坐标系：左手坐标系和右手坐标系。

### 4.2.3 左手坐标系与右手坐标系

如果两个坐标系具有相同的旋向性（handedness），那么我们就可以通过旋转的方法来让它们的坐标轴指向重合。但是，如果它们具有不同的旋向性，那么就无法达到重合的目的。

![左手坐标系](images/chapter04_left_handedness_coordinate_system.png)

左手坐标系

![右手坐标系](images/chapter04_right_handedness_coordinate_system.png)

右手坐标系

除了坐标轴朝向不同，两坐标系对于正向旋转的定义也不同。分别对应左手法则和右手法则。

### 4.2.4 Unity使用的坐标系

对于模型空间和世界空间，Unity使了左手坐标系。这意味着，在模型空间中，一个物体的右侧、上侧、前向分别对应了x轴、y轴、z轴的正方向。

对于观察空间来说，Unity使用的是右手坐标系。观察空间，一般是指以摄像机为原点的坐标系。

### 4.2.5 练习题

1. 在3DS max中，默认的坐标轴方向是：x轴正方向指向右方，y轴正方向指向前方，z轴正方向指向上方。问它是左手坐标系还是右手坐标系？（答：右手坐标系）
2. 在左手坐标系中，有一个点的坐标是(0, 0, 1)。如果把该点绕y轴旋转+90°，旋转后的坐标是多少？如果是在右手坐标系中，有一个点的坐标是（0, 0, 1)。如果把该点绕y轴旋转+90°，旋转后的坐标是多少？（答：在左手坐标系中，结果为(1, 0, 0)。在右手坐标系中，结果为(1, 0, 0)）
3. 在Unity中，新建的场景中主摄像机的位置位于世界空间中的(0, 1, -10)位置，保持Rotation为（0, 0, 0)，Scale为(1, 1, 1)。再在世界空间的(0, 1, 0)位置新建一个球体。问：在相机的观察空间下，球的坐标的z值是多少？在相机的模型空间下，球的坐标的z值是多少？（答：-10, 10）

## 4.3 点和矢量

点（point）是n维空间中的一个位置，它没有大小、宽度这类概念。在游戏中主要使用二维和三维空间。使用 $P=(x, y)$ 表示二维空间的点。使用 $P=(x, y, z)$ 表示三维空间中的点。

矢量（vector），也被称为向量，它的定义更复杂一些。矢量是指n维空间中一种包含了模（magnitude）和方向（direction）的有向线段。

矢量的模是指这个矢量的长度。矢量的模总是大于或等于0.

矢量的方向描述了这个矢量在空间中的指向。

使用 $\vec v = (x, y)$ 来表示二维矢量。

使用 $\vec v = (x, y, z)$ 来表示三维矢量。

使用 $\vec v = (x, y, z, w)$ 来表示四维矢量。

### 4.3.1 点和矢量的区别

![矢量以及它的头与尾](images/chapter04_head_and_tail_of_a_vector.svg)

图4.15 矢量以及它的头与尾

![图4.16 点和矢量之间的关系](images/chapter04_relation_between_point_and_vector.svg)

图4.16 点和矢量之间的关系

如果把矢量的尾固定在坐标系原点，那么这个矢量的表示就和点的表示重合了。如上图所示。

任何一个点都可以表示成一个从原点出发的矢量。

### 4.3.2 矢量运算

#### 4.3.2.1 矢量与标量的乘法、矢量与标量的除法

标量与矢量相乘，结果为该标量与该矢量的各个分量相乘：

$$
k \vec v = (kx, ky, kz)
$$


矢量被一个非零的标量除，结果为该矢量与该标量的倒数相乘：

$$
\frac{\vec v}{k} = \frac{1}{k}\vec v = (\frac{x}{k}, \frac{y}{k}, \frac{z}{k}), k \neq 0
$$

对于乘法来说，矢量与标量的位置可以互换。但是对于除法，只能是矢量被标量除。

从几何意义上看，把一个矢量$\vec v$和一个标量$k$相乘，意味着对矢量$\vec v$进行一个大小为$|k|$的缩放。当$k$小于0时，矢量的方向将会取反。

![矢量与标量的乘法与除法](images/chapter04_scale_vector.png)

图4.17 矢量与标量的乘法与除法

#### 4.3.2.2 矢量与矢量的加减法

两个相同维度的矢量相加或相减，其结果是一个相同维度的新矢量，两个矢量对应分量的相加或相减。

$$
\vec a + \vec b = (a_x + b_x, a_y + b_y, a_z + b_z)
$$

$$
\vec a - \vec b = (a_x - b_x, a_y - b_y, a_z - b_z)
$$

从几何意义上看，矢量$\vec a + \vec b$等于把矢量$\vec a$的头连接到矢量$\vec b$的尾，然后画一条从$\vec a$的尾到$\vec b$的头的矢量。这被称为矢量加法的三角形定则。

![图4.18 二维矢量的加法与减法](images/chapter04_add_and_subtract_of_vector.png)

图4.18 二维矢量的加法与减法

#### 4.3.2.3 矢量的模

$$
|\vec v| = \sqrt{x^2 + y^2 + z^2}
$$

#### 4.3.2.4 单位矢量

单位矢量（unit vector）是指模为1的矢量。也被称之为被归一化的矢量（normalized vector）。

对于任何给定的非零矢量，把它转换成单矢量的过程被称为归一化（normalization）。

通过在一个矢量的头上添加戴帽符号来表示单位矢量，例如 $\hat{\vec v}$.

$$
\hat{\vec v} = \frac{\vec v}{|\vec v|}, 其中 \vec v 是非零矢量
$$

#### 4.3.2.5 矢量的点积

$$
\vec a \cdot \vec b = (a_x, a_y, a_z) \cdot (b_x, b_y, b_z) = a_xb_x + a_yb_y + a_zb_z
$$

点积满足交换律，即 $\vec a \cdot \vec b = \vec b \cdot \vec a$

点积的一个几何意义就是投影（projection）。通俗的解释就是，有一个光源，它发出的光线垂直于 $\hat{\vec a}$ 方向，那么$\vec b$在$\hat{\vec a}$方向上的投影就是$\vec b$在$\hat{\vec a}$方向上的影子。如下图所示。

![图4.22 矢量b在单位矢量a方向上的投影](images/chapter04_vector_b_project_on_vector_a.png)

图4.22 矢量$\vec b$在单位矢量$\hat{\vec a}$方向上的投影

投影结果的正负号与两个向量的夹角有关。

- 当夹角大于90°时，结果小于0；
- 当夹角为90°时，结果为0；
- 当夹角小于90°时，结果大于0；

参见图4.23.

![图4.23 点积的符号](images/chapter04_sign_of_dot_product.png)

性质1：点积可结合标量乘法

$$
(k \vec a) \cdot \vec b = \vec a \cdot (k \vec b) = k(\vec a \cdot \vec b)
$$

性质2：点积与矢量的加法和减法结合

$$
\vec a \cdot (\vec b + \vec c) = \vec a \cdot \vec b + \vec a \cdot \vec c
$$

性质3：一个矢量和本身进行点积的结果，是该矢量的模的平方。

$$
\vec v \cdot \vec v = x^2 + y^2 + z^2 = |\vec v|^2
$$

$$
\vec a \cdot \vec b = |\vec a||\vec b|\cos \theta，\theta为两向量的夹角
$$

#### 4.2.3.6 矢量的叉积

矢量叉积的结果仍是一个矢量。

$$
\vec a \times \vec b = (a_yb_z - a_zb_y, a_zb_x - a_xb_z, a_xb_y - a_yb_x)
$$

![辅助记忆表格](images/chapter04_cross_product_tip_table.png)

辅助记忆表格，结果位于第三个分量。

![辅助记忆三棱柱](images/chapter04_cross_product_tip_triangular_prism.png)

辅助记忆三棱柱，某个面的计算结果对应于对面棱的分量。

叉积不满足交换律，即 $\vec a \times \vec b \neq \vec b \times \vec a$。
叉积满足反交换律，即 $\vec a \times \vec b = -(\vec b \times \vec a)$。
叉积不满足结合律，即 $(\vec a \times \vec b) \times \vec c \neq \vec a \times (\vec b \times \vec c)$。

对两个矢量进行叉积的结果会得到一个同时垂直于这两个矢量的新矢量。

$|\vec a \times \vec b| = |\vec a||\vec b|\sin \theta , 其中 \theta 为两向量的夹角。$

![图4.26 使用矢量a与矢量b构建一个平行四边形](images/chapter04_area_of_2_vectors.png)

这个平行四边形的面积如下：

$$
A = |\vec b|h = |\vec b|(|vec a|\sin \theta) = |\vec a||\vec b|\sin \theta = |\vec a \times \vec b|
$$

![图4.27 分别在左手坐标系和右手坐标系下的叉积结果](images/chapter04_cross_product_in_left_right_handedness_coordinate_system.png)

![图4.28 使用右手法则判断右手坐标系中两向量的叉积的方向](images/chapter04_use_right_headedness.png)

### 4.3.3 练习题

1. 是非题
    1. 一个矢量的大小不重要，我们只需要在正确的位置把它画出来就可以了。（错误，大小很重要。另外矢量没有位置，可以随意把它放在空间的任何位置。）
    2. 点可以认为是位置矢量，这是通过把矢量的尾固定在原点得到的。（正确）
    3. 选择左手坐标系还是右手坐标系很重要，因为这会影响叉积的计算。（错误。无影响。在把数字转换成视学表现的时候，选择不同的坐标系可能会得到不同的结果。）
2. 计算题
    1. $|(2, 7, 3)|$ （结果=$\sqrt{2^2 + 7^2 + 3^2} = \sqrt{62}$）
    2. $2.5(5, 4, 10)$（结果=$(12.5, 10, 25)$）
    3. $\frac{(3,4)}{2}$（结果=$(1.5, 2)$）
    4. 对(5, 12)进行归一化。（$\frac{(5, 12)}{|(5, 12)|} = \frac{(5, 12)}{13}= (\frac{5}{13}, \frac{12}{13})$）
    5. 对(1,1,1)进行归一化。（$\frac{(1,1,1)}{|(1,1,1)|} = \frac{(1,1,1)}{\sqrt{3}} = (\frac{\sqrt 3}{3},\frac{\sqrt 3}{3},\frac{\sqrt 3}{3})$）
    6. (7,4)+(3,5)（结果=$(10,9)$）
    7. (9,4,13)-(15,3,11)（结果=$(-6,1,2)$）
3. 两点间距离问题。假设，场景中有一个光源，位置在（10, 13, 11)处，还有一个点(2,1,1)，那么光源距离该点的距离是多少？答：$d = |(10,13,11) - (2,1,1)| = |(8,12,10)| = \sqrt{8^2+12^2+10^2} = \sqrt{308} = 2 \sqrt{77}$
4. 计算题
    1. $(4,7)\cdot(3,9)$ （答：$4 \times 3 + 7 \times 9 = 12+63 = 75$）
    2. $(2,5,6)\cdot(3,1,2)-10$ （答：$2 \times 3 + 5 \times 1 + 6 \times 2 - 10 = 6+5+12-10 = 13$）
    3. $0.5(-3,4)\cdot(-2,5)$ （答：$(-\frac{3}{2},2)\cdot(-2,5) = -\frac{3}{2}\times(-2)+2\times 5 = 3+10 = 13$）
    4. $(3,-1,2)\times(-5,4,1)$ （答：$(-1 \times 1 - 2 \times 4, 2 \times (-5) - 3 \times 1, 3 \times 4 - (-1)\times(-5)) = (-1 - 8, -10 - 3, 12-5) = (-9,-13,7)$）
    5. $(-5,4,1)\times(3,-1,2)$ （答：根据反交换律，结果 = $-(3,-1,2)\times(-5,4,1) = (9,13,-7)$）
5. 已知矢量$\vec a$和矢量$\vec b$，$\vec a$的模为4，$\vec b$的模为6，它们之间的夹角为60°。计算：
    1. $\vec a \cdot \vec b$ （结果 = $|\vec a||\vec b|\cos60° = 4 \times 6 \times \frac{1}{2} = 12$）
    2. $|\vec a \times \vec b|$ （结果= $|\vec a||\vec b|\sin60° = 4 \times 6 \times \frac{\sqrt3}{2} = 12\sqrt3$）
6. 假设，场景中有一个NPC，它位于点p处，它的前方（forward)可以使用矢量$\vec v$来表示.
    1. 如果现在玩家运动到了点x处，那么如何判断玩家是在NPC的前方还是后方？请使用数学公式来描述你的答案。提示：使用点积。（计算 $(x - p) \cdot \vec v$ 的大小，如果点积的结果大于0说明玩家在NPC的前方，如果等于0，说明玩家在NPC的左侧或者右侧，如果小于0，则说明玩家在NPC的后方。）
    2. 使用你在1中提到的方法，代入 $p=(4,2), v=(-3,4), x=(10,6)$ 来验证你的答案。 （代入计算得-2，所以玩家位于NPC的后方。）
    3. 现在，游戏有了新的需求：NPC只能观察到有限的视角范围，这个视角的角度是$\phi$，也就是说NPC最多只能看到它前方左侧或者右侧$\frac{\phi}{2}$角度内的物体。那么我们如何通过点积来判断NPC是否能看到点x呢？（设$\theta$为$\vec v 与 \vec{PX}$向量的夹角，如果$\theta 小于 \frac{\phi}{2}$, 那么NPC就能看到点x。想要使$\theta 小于 \frac{\phi}{2}$，只要使$\cos\theta > \cos\frac{\phi}{2}$。而其中的$\cos\theta = \frac{\vec{PX}\cdot\vec v}{|\vec{PX}||\vec v|}$。也即$\frac{\vec{PX}\cdot\vec v}{|\vec{PX}||\vec v|} > \cos\frac{\phi}{2}$时，就能看到点x，否则看不到点x。）
    4. 在第3条的基础上，策划又有了新的需求：NPC的观察距离也有了限制，它只能看到固定距离内的对象，现在该如何判断呢？（设NPC的最大观察距离为d，则能看到点x的条件之一为$|\vec{PX}| \le d$，结合第3条的结果，两个条件都满足才能看到，即$|\vec{PX}| \le d 且 \frac{\vec{PX}\cdot\vec v}{|\vec{PX}||\vec v|} > \cos\frac{\phi}{2}$时才能看到点x。）
7. 在渲染中我们常常会需要判断一个三角面片是正面还背面，这可以通过判断三角形的3个顶点在当前空间中是顺时针还是逆时针排列来得到。给定三角形的3个顶点$p_1,p_2,p_3$，如何利用叉积来判断这3个顶点的顺序是顺时针还是逆时针？假设我们使用的是左手坐标系，且$p_1,p_2,p_3$都位于xy平面，人眼位于z轴的负方向上，向z轴正方向观察，如图4.29所示。

![图4.29](images/chapter04_check_triangle_front_or_back_by_cross_product.png)

答：取向量 $\vec a = (\vec p_2 - \vec p_1), \vec b = (\vec p_3 - \vec p_1)$，求$\vec a \times \vec b$的结果。如果叉积结果向量的z分量大于0，说明是顺时针。如果小于0，说明是逆时针。如果为0，说明这三个点共线，无法构成三角形。
